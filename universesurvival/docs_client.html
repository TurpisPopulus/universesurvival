<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Universe Survival Client - Документация</title>
    <style>
      :root {
        color-scheme: light;
        --ink: #1e1c18;
        --muted: #5a524a;
        --bg: #f4efe6;
        --accent: #1f6f5f;
        --accent-soft: #cde7df;
        --warm: #f3c37a;
        --panel: #ffffff;
        --stroke: rgba(30, 28, 24, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", "Tahoma", sans-serif;
        background:
          radial-gradient(circle at 15% 15%, #fff9ef 0%, transparent 55%),
          radial-gradient(circle at 85% 10%, #e2f3ee 0%, transparent 52%),
          var(--bg);
        color: var(--ink);
      }

      .page {
        max-width: 1040px;
        margin: 0 auto;
        padding: 36px 20px 60px;
        position: relative;
      }

      header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand {
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .tag {
        background: var(--accent-soft);
        color: var(--accent);
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
      }

      .hero {
        margin-top: 28px;
        padding: 26px;
        border-radius: 24px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        box-shadow: 0 20px 60px rgba(30, 28, 24, 0.12);
      }

      h1 {
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: clamp(32px, 4vw, 44px);
        margin: 0 0 10px;
      }

      p {
        line-height: 1.6;
        color: var(--muted);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
        margin-top: 22px;
      }

      .card {
        background: var(--panel);
        border-radius: 18px;
        padding: 18px;
        border: 1px solid var(--stroke);
      }

      .card h3 {
        margin-top: 0;
      }

      .section {
        margin-top: 32px;
      }

      .section h2 {
        margin-bottom: 10px;
      }

      pre {
        margin: 0;
        padding: 14px;
        background: #101417;
        color: #f0f3f7;
        border-radius: 14px;
        overflow-x: auto;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 14px;
      }

      code {
        font-family: "Consolas", "Courier New", monospace;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(31, 111, 95, 0.15);
        color: var(--accent);
        font-weight: 600;
        font-size: 12px;
      }

      .note {
        background: linear-gradient(120deg, rgba(31, 111, 95, 0.1), rgba(243, 195, 122, 0.25));
        border-radius: 16px;
        padding: 16px;
        border: 1px dashed rgba(31, 111, 95, 0.3);
      }

      ul {
        margin: 8px 0 0 18px;
        color: var(--muted);
      }

      footer {
        margin-top: 40px;
        font-size: 14px;
        color: var(--muted);
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div class="brand">Universe Survival Client</div>
        <div class="tag">Структура · Godot</div>
      </header>

      <section class="hero">
        <h1>Клиент: только структура, масштабируемо</h1>
        <p>
          Клиент отображает мир и отправляет действия игрока. Истина всегда у сервера,
          локальные JSON используются только для настроек и кеша интерфейса.
        </p>
        <div class="grid">
          <div class="card">
            <h3>Источник истины</h3>
            <p><span class="pill">Server RAM</span> Клиент синхронизирует копию мира.</p>
          </div>
          <div class="card">
            <h3>Категории сущностей</h3>
            <p>Ресурсы, объекты, NPC отображаются на отдельных слоях.</p>
          </div>
          <div class="card">
            <h3>Масштаб</h3>
            <p>Чанк-стриминг, кэш видимости, загрузка по версиям.</p>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>План структуры проекта</h2>
        <p>Эталонная структура для роста проекта.</p>
        <pre><code>universesurvival/
  main_menu.tscn
  main.tscn
  scenes/
    player.tscn
    remote_player.tscn
    world/
      world_root.tscn
  scripts/
    Net/
      UdpClient.gd
      PacketRouter.gd
    World/
      WorldStream.gd
      ChunkCache.gd
    Entities/
      EntityRegistry.gd
      ResourceView.gd
      ObjectView.gd
      NpcView.gd
    UI/
      Hud.gd
      AdminPanel.gd
  data/
    client_settings.json</code></pre>
      </section>

      <section class="section">
        <h2>Сцены и ответственность</h2>
        <div class="card">
          <ul>
            <li><code>main_menu.tscn</code> — вход, регистрация, статус сервера.</li>
            <li><code>main.tscn</code> — игровая сцена, подключение, HUD.</li>
            <li><code>player.tscn</code> — локальный игрок и ввод.</li>
            <li><code>remote_player.tscn</code> — удаленные игроки.</li>
            <li><code>world_root.tscn</code> — TileMap и слои сущностей.</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Системы клиента</h2>
        <div class="grid">
          <div class="card">
            <h3>Net</h3>
            <p>UDP-обмен, маршрутизация пакетов, контроль частоты.</p>
          </div>
          <div class="card">
            <h3>WorldStream</h3>
            <p>Запрос чанков и сущностей по версии, поддержка кэша.</p>
          </div>
          <div class="card">
            <h3>EntityRegistry</h3>
            <p>Реестр сущностей: ресурсы, объекты, NPC, игроки.</p>
          </div>
          <div class="card">
            <h3>Render Layers</h3>
            <p>Раздельные визуальные слои: terrain, resources, objects, npc.</p>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>Потоки данных</h2>
        <div class="card">
          <p>Основные сценарии синхронизации:</p>
          <pre><code>LOGIN -> OK -> spawn игрока
Движение -> SEND id|name|x|y -> получение списка игроков
CHUNK|cx|cy|ver -> обновление карты
RESOURCES|cx|cy|ver -> ресурсы в чанке
OBJECTS|cx|cy|ver -> объекты в чанке
NPCS|cx|cy|ver -> NPC в чанке</code></pre>
          <p>Клиент обновляет локальную копию только по ответам сервера.</p>
        </div>
      </section>

      <section class="section">
        <h2>Стриминг и кэш чанков</h2>
        <div class="card">
          <ul>
            <li>Радиус видимости задается настройкой (например, 5x5 чанков).</li>
            <li>Клиент хранит кэш чанков по версии, не перерисовывает без изменений.</li>
            <li>Выход из радиуса — чанк выгружается из памяти и освобождает спрайты.</li>
          </ul>
          <p>Кэш — это копия, источник истины всегда сервер.</p>
        </div>
      </section>

      <section class="section">
        <h2>Ресурсы, объекты, NPC (отображение)</h2>
        <div class="card">
          <p>Каждый тип сущности имеет свой визуальный контроллер.</p>
          <pre><code>ResourceView
- спрайт по typeId
- эффекты добычи

ObjectView
- статическая модель/спрайт
- интерактивная подсветка

NpcView
- анимации состояния
- индикаторы здоровья</code></pre>
          <p>Состояние приходит с сервера и применяется в Registry.</p>
        </div>
      </section>

      <section class="section">
        <h2>Поведение при разрыве</h2>
        <div class="card">
          <ul>
            <li>Клиент сохраняет последнюю позицию камеры и UI.</li>
            <li>После переподключения заново запрашивает чанки по версии 0.</li>
            <li>Старые сущности очищаются перед полной синхронизацией.</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Интеракции игрока</h2>
        <div class="card">
          <ul>
            <li>Клик/клавиша формирует запрос на сервер (добыча, использовать объект).</li>
            <li>Сервер подтверждает действие и присылает обновление состояния.</li>
            <li>Клиент не применяет изменения без подтверждения.</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Админский редактор карты</h2>
        <div class="card">
          <ul>
            <li>Вход: Admin -> Map Editor включает режим редактирования для <code>WorldMap</code>.</li>
            <li>Выбор тайла через <code>TilePalette</code>, клик по карте меняет тайл локально.</li>
            <li>Локальные правки складируются в <code>_pending_changes</code> и не уходят на сервер сразу.</li>
            <li>Кнопка "Сохранить" отправляет пакет <code>EDIT</code> с массивом изменений.</li>
            <li>Кнопка "Назад" очищает pending и запрашивает чанки заново, возвращая карту к состоянию сервера.</li>
          </ul>
          <p>Если в редакторе приходят ответы чанков, клиент повторно применяет pending-тайлы поверх обновления, чтобы не потерять локальные правки до сохранения.</p>
        </div>
      </section>

      <section class="section">
        <h2>Локальные JSON</h2>
        <div class="card">
          <p>Используются только для:</p>
          <ul>
            <li>настроек клиента (последний адрес сервера, громкость);</li>
            <li>кэша UI (последняя вкладка и т.п.).</li>
          </ul>
          <p>Локальные JSON никогда не меняют состояние мира.</p>
        </div>
      </section>

      <section class="section note">
        <h2>Примечание для развития</h2>
        <p>
          Этот документ описывает структуру. Перед добавлением новой системы
          обновляй <code>docs_client.html</code> и фиксируй изменения в <code>ver_client.html</code>.
        </p>
      </section>

      <footer>
        <p>Документация структуры клиента. Основа для дальнейшей реализации.</p>
      </footer>
    </div>
  </body>
</html>
