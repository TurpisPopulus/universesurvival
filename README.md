# Universe Survival

MMORPG-выживание с UDP-сервером на C# и клиентом на Godot.

## Структура проекта

- `server/` - сервер (C#), запуск через `run_server.bat` или `dotnet run`
- `universesurvival/` - клиент (Godot 4), открывай проект
- `server/docs_server.html` - документация по серверу
- `universesurvival/docs_client.html` - документация по клиенту
- `server/ver_server.html` и `universesurvival/ver_client.html` - история версий

## Быстрый старт

1. Запусти сервер: `server/run_server.bat`
2. Открой проект в Godot и запусти сцену `main_menu.tscn`
3. Создай персонажа (Create Player) и войди (Enter)

## Ключевые возможности

### Сервер (C#)
- UDP-протокол с шифрованием SEC1 (HMAC-SHA256)
- RAM-first архитектура: вся симуляция в памяти
- Версионирование чанков карты/объектов/ресурсов
- Система блокировок и поверхностей
- Rate limiting и мониторинг производительности
- Автосохранение в JSON

### Клиент (Godot 4)
- Система множественных тайлсетов с автоматическим сканированием (TilesetManager)
- Редакторы: карты с панелью статусов, ресурсов
- Визуализация статусов цветными буквами (B, S, D, I, M)
- Paperdoll-система для персонажей с анимацией
- Загрузочный экран с прогресс-баром
- Меню паузы с настройками видео

## Система тайлсетов

Клиент автоматически загружает все PNG файлы из папки `tiles/`:

- Автоматическое сканирование: TilesetManager и TilePalette загружают все PNG из `universesurvival/tiles/`
- Глобальные ID: `tileset_index * 100000 + local_tile_id`
- Пример: `terrain:5 = 5`, `ground:52 = 100052`
- Переключение тайлсета в редакторе не меняет существующие тайлы на карте
- Сортировка по алфавиту для стабильного порядка индексов

### Добавление нового тайлсета

1. Создай PNG с тайлами 32x32 (размер кратен 32)
2. Положи в `universesurvival/tiles/` (например, `buildings.png`)
3. Тайлсет автоматически появится в редакторе (имя = название файла без .png)
4. TilesetManager автоматически присвоит ему следующий свободный индекс

## Редактор карты

Редактор карты содержит две панели:
- **Слева:** Палитра тайлов с выпадающим списком для выбора тайлсета (автоматическая прокрутка)
- **Справа:** Панель статусов с кнопками:
  - **B** - Блокировка (красная, непроходимо)
  - **S** - Shallow Water (мелководье, голубая)
  - **D** - Deep Water (глубина, синяя)
  - **I** - Ice (лёд, светло-голубая)
  - **M** - Mud (болото, коричневая)
  - **✖** - Очистить статус

Статусы отображаются как цветные буквы на карте в режиме редактирования

## Файловая структура

### Данные сервера
```
server/
  Program.cs              # основной код сервера
  run_server.bat          # запуск
  accounts.json           # аккаунты с хэшами паролей
  players.json            # состояния игроков
  object_types.json       # каталог объектов
  resource_types.json     # каталог ресурсов
  blocking_types.json     # каталог блокировок
  surface_types.json      # каталог поверхностей
  Data/
    chunk_*.json          # чанки карты
    objects_*.json        # чанки объектов
    resources_*.json      # чанки ресурсов
    blocking_*.json       # чанки блокировок
    surface_*.json        # чанки поверхностей
```

### Данные клиента
```
universesurvival/
  Main.gd, main.tscn           # игровая сцена
  MainMenu.gd, main_menu.tscn  # главное меню
  Player.gd                     # локальный игрок
  RemotePlayer.gd               # удаленные игроки
  WorldMap.gd                   # карта (TileMap)
  WorldObjects.gd               # объекты
  WorldResources.gd             # ресурсы
  WorldBlocking.gd              # блокировки
  WorldSurface.gd               # поверхности
  TilesetManager.gd             # менеджер тайлсетов (автосканирование tiles/)
  TilePalette.gd                # палитра тайлов
  ResourcePalette.gd            # палитра ресурсов
  BlockingPalette.gd            # палитра блокировок
  SurfacePalette.gd             # палитра поверхностей
  UnifiedMapEditor.gd/tscn      # унифицированный редактор
  CharacterAppearance.gd        # paperdoll персонажа
  NetworkCrypto.gd              # шифрование UDP
  data/
    object_types.json
    resource_types.json
    blocking_types.json
    surface_types.json
  tiles/
    terrain.png                 # базовый тайлсет
    Ground.png                  # дополнительный тайлсет
    objects.png, objects_palette.png
  resources/
    tree_oak.png, tree_pine.png
  characters/
    body_*.png, heads.png, hair_*.png, etc.
```

## Протокол

Все UDP-сообщения шифруются в конверт SEC1:
```
SEC1|base64(version|nonce|ciphertext|mac)
```

Основные команды:
- `LOGIN|name|password` - вход
- `REGISTER|name|password|appearance` - регистрация
- `id|name|x|y|appearance` - позиционный пакет
- `CHUNK|cx|cy|lastVersion` - запрос чанка карты
- `EDIT|{...}` - изменение карты
- `OBJECTS|cx|cy|lastVersion` - запрос объектов
- `OBJECT_EDIT|{...}` - изменение объектов
- `RESOURCES|cx|cy|lastVersion` - запрос ресурсов
- `RESOURCE_EDIT|{...}` - изменение ресурсов
- `BLOCKING|cx|cy|lastVersion` - запрос блокировок
- `BLOCKING_EDIT|{...}` - изменение блокировок
- `SURFACE|cx|cy|lastVersion` - запрос поверхностей
- `SURFACE_EDIT|{...}` - изменение поверхностей

## Безопасность

- Все UDP-пакеты шифруются и подписываются (HMAC-SHA256)
- Пароли хранятся как PBKDF2 хэш + соль
- Rate limiting: 120 пакетов/сек по умолчанию
- Общий ключ шифрования можно задать через `UNIVERSE_NET_KEY` (base64)

⚠️ Общий ключ находится в клиенте и может быть извлечен. Для production используйте DTLS/Noise.

## Разработка

### Правило обновления документации

При изменениях:
1. Сервер → обнови `server/docs_server.html` и `server/ver_server.html` (+0.001)
2. Клиент → обнови `universesurvival/docs_client.html` и `universesurvival/ver_client.html` (+0.001)
3. Обнови `README.md` если добавляешь крупные фичи

### Последние изменения

**v0.077** (клиент, 2026-01-14):
- Реализована взаимоисключающая логика выбора между тайлами и статусами в редакторе карт
- При выборе тайла автоматически снимается выделение со статусов (и наоборот)
- Использование `set_pressed_no_signal()` и `release_focus()` для корректного управления кнопками
- Отслеживание текущего режима редактирования (`_current_edit_mode`)
- Функция сохранения теперь сохраняет все три слоя: тайлы, блокировки и поверхности

**v0.076** (клиент, 2026-01-12):
- Удалена кнопка "Размещение объектов" из админ-меню
- Автоматическая загрузка всех PNG из папки tiles/ (больше не нужен tilesets.json)
- Панель статусов перемещена в редактор карт справа от палитры тайлов
- Кнопки статусов: B (блокировка), S (мелководье), D (глубина), I (лёд), M (болото)
- Улучшена визуализация статусов: цветные буквы размером 20px
- Редактор карт автоматически включает режим редактирования для блокировок и поверхностей

**v0.075** (клиент, 2026-01-11):
- Реализована система множественных тайлсетов (TilesetManager)
- Глобальные ID тайлов для сохранения вида при переключении тайлсетов
- Вертикальная прокрутка в палитре тайлов
- Конфигурация тайлсетов через JSON

См. полную историю в `ver_client` и `ver_server`.

## Лицензия

Проект находится в разработке.
