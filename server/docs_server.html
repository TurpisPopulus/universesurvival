<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Universe Survival Server - Документация</title>
    <style>
      :root {
        color-scheme: light;
        --ink: #1e1c18;
        --muted: #5a524a;
        --bg: #f4efe6;
        --accent: #1f6f5f;
        --accent-soft: #cde7df;
        --warm: #f3c37a;
        --panel: #ffffff;
        --stroke: rgba(30, 28, 24, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", "Tahoma", sans-serif;
        background:
          radial-gradient(circle at 15% 15%, #fff9ef 0%, transparent 55%),
          radial-gradient(circle at 85% 10%, #e2f3ee 0%, transparent 52%),
          var(--bg);
        color: var(--ink);
      }

      .page {
        max-width: 1040px;
        margin: 0 auto;
        padding: 36px 20px 60px;
        position: relative;
      }

      header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .brand {
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }

      .tag {
        background: var(--accent-soft);
        color: var(--accent);
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 13px;
        font-weight: 600;
      }

      .hero {
        margin-top: 28px;
        padding: 26px;
        border-radius: 24px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        box-shadow: 0 20px 60px rgba(30, 28, 24, 0.12);
      }

      h1 {
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
        font-size: clamp(32px, 4vw, 44px);
        margin: 0 0 10px;
      }

      p {
        line-height: 1.6;
        color: var(--muted);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
        margin-top: 22px;
      }

      .card {
        background: var(--panel);
        border-radius: 18px;
        padding: 18px;
        border: 1px solid var(--stroke);
      }

      .card h3 {
        margin-top: 0;
      }

      .section {
        margin-top: 32px;
      }

      .section h2 {
        margin-bottom: 10px;
      }

      pre {
        margin: 0;
        padding: 14px;
        background: #101417;
        color: #f0f3f7;
        border-radius: 14px;
        overflow-x: auto;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 14px;
      }

      code {
        font-family: "Consolas", "Courier New", monospace;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(31, 111, 95, 0.15);
        color: var(--accent);
        font-weight: 600;
        font-size: 12px;
      }

      .note {
        background: linear-gradient(120deg, rgba(31, 111, 95, 0.1), rgba(243, 195, 122, 0.25));
        border-radius: 16px;
        padding: 16px;
        border: 1px dashed rgba(31, 111, 95, 0.3);
      }

      ul {
        margin: 8px 0 0 18px;
        color: var(--muted);
      }

      footer {
        margin-top: 40px;
        font-size: 14px;
        color: var(--muted);
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div class="brand">Universe Survival Server</div>
        <div class="tag">Структура · RAM-first</div>
      </header>

      <section class="hero">
        <h1>Сервер: только структура, масштабируемо</h1>
        <p>
          Эта документация описывает <strong>каркас сервера</strong>. Истина всегда в RAM:
          JSON используется <strong>только</strong> как хранение и резервные снимки.
          Реализация функций может отличаться, но структура и контракт остаются стабильными.
        </p>
        <div class="grid">
          <div class="card">
            <h3>Главный принцип</h3>
            <p><span class="pill">RAM = truth</span> Все игровые данные живут в памяти.</p>
          </div>
          <div class="card">
            <h3>JSON</h3>
            <p>Снимки, импорт/экспорт, резерв. Не используется как источник истины.</p>
          </div>
          <div class="card">
            <h3>Сущности</h3>
            <p>Ресурсы, объекты, NPC вынесены в отдельные регистры и слои.</p>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>Архитектурные принципы</h2>
        <div class="grid">
          <div class="card">
            <h3>Серверная авторитетность</h3>
            <p>Сервер единственный, кто изменяет состояние мира. Клиент только запрашивает и предлагает.</p>
          </div>
          <div class="card">
            <h3>Версионирование</h3>
            <p>Все слои мира имеют версию: чанки карты, сущности и события синхронизируются по версиям.</p>
          </div>
          <div class="card">
            <h3>Масштабируемость</h3>
            <p>Мир делится на чанки и зоны; сущности адресуются по чанку.</p>
          </div>
          <div class="card">
            <h3>Снимки</h3>
            <p>Снимки пишутся пакетно и атомарно, без блокировки игры.</p>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>План структуры проекта</h2>
        <p>Текущая структура может отличаться. Ниже эталон для развития.</p>
        <pre><code>server/
  Program.cs                # точка входа, UDP loop, маршрутизация
  Net/                       # сетевой слой и протокол
    Packets/
    Handlers/
  Domain/
    World/                   # карта, чанки, слои, правила
    Resources/               # добываемые ресурсы
    Objects/                 # размещаемые объекты
    NPC/                     # монстры, животные, ИИ
    Players/                 # игроки, сессии, доступы
  Persistence/
    Snapshots/               # сборка снимков, сериализация JSON
    Import/                  # загрузка JSON при старте
  Config/
    server.json              # конфиг сервера (порт, интервалы)
  Data/                      # runtime snapshots, не в коде
    players.json
    accounts.json
    chunk_*.json
    resources_*.json
    objects_*.json
    npcs_*.json</code></pre>
      </section>

      <section class="section">
        <h2>Модель мира</h2>
        <div class="card">
          <p><strong>Чанки:</strong> сетка чанков, стандартно 100x100 тайлов.</p>
          <p><strong>Слои:</strong> terrain, resources, objects, npc, overlays (эффекты).</p>
          <p><strong>Версии:</strong> каждый чанк имеет версию для диффов.</p>
          <p><strong>Адресация:</strong> (cx, cy) + локальные координаты (x, y).</p>
          <p><strong>Границы:</strong> одна сущность не может находиться сразу в двух чанках.</p>
        </div>
      </section>

      <section class="section">
        <h2>Единая форма сущности (RAM)</h2>
        <div class="card">
          <p>Все игровые сущности наследуют общий минимум полей.</p>
          <pre><code>EntityBase
- entityId: string          # уникальный id в мире
- typeId: string            # тип из каталога (ResourceType/ObjectType/NpcType)
- chunkId: (cx, cy)
- position: (x, y)
- stateVersion: int
- tags: string[]
- flags: bitmask
- ownerId: string?          # для приватных объектов
- createdUtc: DateTime
- updatedUtc: DateTime</code></pre>
          <p>Изменения увеличивают <code>stateVersion</code>, чтобы клиент мог синхронизироваться по диффам.</p>
        </div>
      </section>

      <section class="section">
        <h2>Ресурсы (добываемые)</h2>
        <div class="card">
          <p>Ресурс - объект мира, который можно добывать (дерево, камень, руда).</p>
          <pre><code>ResourceNode : EntityBase
- hitPoints: int
- maxHitPoints: int
- regenSeconds: int
- lootTableId: string
- state: alive | depleted
- respawnUtc: DateTime?</code></pre>
          <p>Поведение:</p>
          <ul>
            <li>Добыча уменьшает HP, при нуле ресурс исчезает.</li>
            <li>После respawnSeconds появляется снова, получает новую версию.</li>
            <li>Вещи, полученные с ресурса, формируются на сервере.</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Объекты (размещаемые)</h2>
        <div class="card">
          <p>Объекты - статические конструкции: стены, заборы, колодцы, стулья.</p>
          <pre><code>WorldObject : EntityBase
- durability: int
- maxDurability: int
- interactionId: string?    # открыть, включить, использовать
- storageId: string?        # контейнер
- isBlocking: bool
- rotation: int             # 0-3
- ownerGroupId: string?</code></pre>
          <p>Поведение:</p>
          <ul>
            <li>Объекты могут быть интерактивными (дверь/контейнер).</li>
            <li>Разрушение приводит к луту и очистке объекта.</li>
            <li>Размещение валидируется по правилам (коллизии, зона).</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>NPC (монстры, животные)</h2>
        <div class="card">
          <p>NPC управляются серверной симуляцией и AI.</p>
          <pre><code>Npc : EntityBase
- brainId: string
- health: int
- maxHealth: int
- aggression: passive | neutral | hostile
- patrolPathId: string?
- targetEntityId: string?
- lootTableId: string?</code></pre>
          <p>Поведение:</p>
          <ul>
            <li>AI запускается по тикам и обновляет состояние NPC.</li>
            <li>Смерть NPC создает лут и таймер респавна.</li>
            <li>Перемещение фиксируется на сервере, клиент получает позиции.</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Каталоги типов (данные контента)</h2>
        <div class="card">
          <p>Каталоги описывают свойства типов (не экземпляров). Загружаются при старте в RAM.</p>
          <pre><code>ResourceType
- typeId, displayName, iconId
- hitPoints, regenSeconds, lootTableId

ObjectType
- typeId, displayName, iconId
- durability, isBlocking, interactionId

NpcType
- typeId, displayName, modelId
- health, aggression, brainId</code></pre>
          <p>Каталоги могут храниться в JSON, но после старта всегда живут в RAM.</p>
        </div>
      </section>

      <section class="section">
        <h2>Сетевой контракт</h2>
        <div class="card">
          <p>Протокол минимальный, UDP. Команды расширяются, но формат един:</p>
          <pre><code>PING
REGISTER|name|password
LOGIN|name|password
OK|x|y|accessLevel
ERR|code

CHUNK|cx|cy|lastVersion
EDIT|{...}

RESOURCES|cx|cy|lastVersion
OBJECTS|cx|cy|lastVersion
NPCS|cx|cy|lastVersion</code></pre>
          <p>Ответы на новые запросы будут JSON-снимками по версиям.</p>
        </div>
      </section>

      <section class="section">
        <h2>Идентификаторы и версии</h2>
        <div class="card">
          <ul>
            <li><strong>entityId</strong> — уникален в пределах всего мира.</li>
            <li><strong>typeId</strong> — привязка к каталогу типов, стабильный ключ.</li>
            <li><strong>stateVersion</strong> — увеличивается при каждом изменении сущности.</li>
            <li><strong>chunkVersion</strong> — версия слоя в чанке (terrain/resources/objects/npcs).</li>
          </ul>
          <p>Версии используются для диффов: клиент запрашивает изменения с последней версии.</p>
        </div>
      </section>

      <section class="section">
        <h2>Формат JSON-снимков (хранение)</h2>
        <div class="card">
          <p>Снимки пишутся на диск, но после загрузки живут только в RAM.</p>
          <pre><code>{
  "chunk": { "x": 0, "y": 0, "version": 12 },
  "resources": [
    { "entityId": "res-0001", "typeId": "tree_oak", "x": 12, "y": 9, "hp": 30, "stateVersion": 7 }
  ],
  "objects": [
    { "entityId": "obj-0100", "typeId": "wall_wood", "x": 15, "y": 9, "durability": 80 }
  ],
  "npcs": [
    { "entityId": "npc-2001", "typeId": "wolf", "x": 18, "y": 12, "health": 40 }
  ]
}</code></pre>
          <p>Сервер может сохранять слой отдельно или объединенно — структура гибкая.</p>
        </div>
      </section>

      <section class="section">
        <h2>Снимки и хранение</h2>
        <div class="card">
          <p>Снимки пишутся периодически или при завершении сервера.</p>
          <ul>
            <li>JSON хранит только копию RAM.</li>
            <li>Каждый слой имеет отдельные файлы: чанки карты, ресурсы, объекты, NPC.</li>
            <li>Сохранение атомарное: через временный файл.</li>
            <li>Загрузка восстанавливает RAM, но не считается источником истины.</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Тики и симуляция</h2>
        <div class="card">
          <p>Сервер работает в несколько циклов:</p>
          <ul>
            <li>Network Tick: прием/отправка UDP.</li>
            <li>World Tick: NPC, реген ресурсов, таймеры.</li>
            <li>Persistence Tick: сохранение грязных данных.</li>
          </ul>
          <p>Все тики изменяют данные только через RAM-структуры.</p>
        </div>
      </section>

      <section class="section">
        <h2>Конфигурация</h2>
        <div class="card">
          <p>Все параметры сервера задаются через конфиг и не требуют перекомпиляции.</p>
          <pre><code>{
  "port": 7777,
  "saveIntervalSec": 300,
  "chunkSaveIntervalSec": 30,
  "activeWindowSec": 10,
  "world": {
    "chunkSize": 100,
    "viewRadius": 2
  }
}</code></pre>
          <p>Конфиг грузится в RAM и применяется ко всем подсистемам.</p>
        </div>
      </section>

      <section class="section">
        <h2>Валидация и доступы</h2>
        <div class="card">
          <p>Сервер проверяет:</p>
          <ul>
            <li>Права изменения мира (уровни доступа).</li>
            <li>Коллизии при размещении объектов.</li>
            <li>Диапазоны координат и частоту пакетов.</li>
          </ul>
          <p>Клиентские данные не считаются достоверными.</p>
        </div>
      </section>

      <section class="section note">
        <h2>Примечание для развития</h2>
        <p>
          Документ описывает структуру. При реализации новых модулей сначала обновляй
          этот файл, затем добавляй код и фиксируй версию в <code>ver_server.html</code>.
        </p>
      </section>

      <footer>
        <p>Документация структуры сервера. Основа для дальнейшей реализации.</p>
      </footer>
    </div>
  </body>
</html>
