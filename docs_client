# Документация клиента Universe Survival

## Общая информация
Клиент написан на Godot 4.5.1 с использованием GDScript. Использует UDP-протокол с шифрованием для связи с сервером.

## Основные компоненты

### Main.gd / main.tscn
Главная игровая сцена, содержит:
- Управление игровым циклом
- Координацию между всеми системами (карта, объекты, ресурсы, блокировки, поверхности)
- Админ-панель с редакторами
- Систему паузы и настроек
- Обработку режимов редактирования

#### Переменные состояния
- `_current_edit_mode: String` - текущий режим редактирования ("tiles", "status", "none")
- `_updating_status_buttons: bool` - флаг для предотвращения рекурсии при программном изменении кнопок

#### Ключевые методы
- `_on_tile_selected(tile_id)` - обработка выбора тайла, снятие выбора статусов
- `_on_status_*_pressed()` - обработчики кнопок статусов, снятие выбора тайлов
- `_unpress_all_status_buttons()` - снятие нажатия со всех кнопок статусов с использованием `set_pressed_no_signal()` и `release_focus()`
- `_clear_tile_palette_selection()` - очистка визуального выделения в палитре тайлов
- `_on_map_editor_save_pressed()` - сохранение всех слоев (тайлы, блокировки, поверхности)

### MainMenu.gd / main_menu.tscn
Главное меню игры:
- Вход в игру (LOGIN)
- Регистрация нового персонажа (REGISTER)
- Выбор внешности через CharacterAppearance
- Загрузочный экран с прогресс-баром

### Player.gd
Управление локальным игроком:
- Обработка ввода (WASD, стрелки)
- Отправка позиции на сервер
- Применение CharacterAppearance
- Обработка коллизий с блокировками
- Модификация скорости на разных поверхностях

### RemotePlayer.gd
Отображение удаленных игроков:
- Синхронизация позиции
- Применение внешности
- Интерполяция движения

### WorldMap.gd
Система карты:
- TileMap с поддержкой множественных тайлсетов
- Загрузка чанков с сервера по протоколу CHUNK
- Редактирование тайлов (EDIT)
- Версионирование для дельта-обновлений
- Глобальные ID тайлов: `tileset_index * 100000 + local_tile_id`

#### Методы
- `load_tileset(tileset_name)` - загрузка тайлсета по имени
- `set_selected_tile(tile_id)` - выбор тайла для рисования
- `save_map_changes()` - отправка изменений на сервер

### WorldObjects.gd
Система объектов:
- Размещение объектов на карте (деревья, камни и т.д.)
- Редактор объектов (OBJECT_EDIT)
- Версионирование чанков объектов

### WorldResources.gd
Система ресурсов:
- Размещение ресурсов (руда, растения)
- Редактор ресурсов (RESOURCE_EDIT)
- Версионирование чанков ресурсов

### WorldBlocking.gd
Система блокировок:
- Визуализация непроходимых зон буквой "B"
- Редактирование блокировок (BLOCKING_EDIT)
- Проверка проходимости для Player
- Видимость для администраторов (access_level == 1) всегда включена
- В режиме редактора видна всем

#### Параметры экспорта
- `access_level: int` - уровень доступа пользователя (1 = админ)

#### Методы
- `set_editor_mode(enabled)` - включение/выключение режима редактирования
- `set_access_level(level)` - установка уровня доступа
- `set_selected_block(type_id)` - выбор типа блокировки для рисования
- `save_blocking_changes()` - отправка изменений на сервер
- `is_position_blocked(tile_pos)` - проверка блокировки позиции

### WorldSurface.gd
Система поверхностей:
- Визуализация поверхностей цветными буквами (S, D, I, M)
- Редактирование поверхностей (SURFACE_EDIT)
- Модификация скорости игрока
- Z-index = 1 (выше тайлов, ниже блокировок)

#### Типы поверхностей
- Shallow Water (S) - мелководье (голубой)
- Deep Water (D) - глубина (синий)
- Ice (I) - лёд (светло-голубой)
- Mud (M) - болото (коричневый)

### TilesetManager.gd
Автоматический менеджер тайлсетов:
- Сканирование папки `tiles/` для PNG файлов
- Автоматическое присвоение индексов (сортировка по алфавиту)
- Глобальные ID тайлов
- Регистрация тайлсетов без конфигурационных файлов

#### Методы
- `scan_tilesets()` - сканирование папки tiles/
- `register_tileset(name, path)` - регистрация тайлсета
- `get_tileset_index(name)` - получение индекса по имени
- `get_tileset_name(index)` - получение имени по индексу

### TilePalette.gd
Палитра тайлов:
- Отображение тайлов текущего тайлсета
- Вертикальная прокрутка
- Выбор тайла для рисования
- Выпадающий список для выбора тайлсета
- Визуальное выделение выбранного тайла
- Метод `clear_selection()` для снятия выделения

### CharacterAppearance.gd
Система paperdoll для персонажей:
- Слои: body, head, hair, shirt, pants, shoes
- JSON формат для сохранения/загрузки
- Анимация движения (4 направления)

### NetworkCrypto.gd
Шифрование UDP:
- SEC1 конверт: `SEC1|base64(version|nonce|ciphertext|mac)`
- HMAC-SHA256 для подписи
- ChaCha20 для шифрования (fallback на AES если недоступен)

## Редактор карт

### Структура редактора
Редактор карты состоит из двух панелей:

#### Левая панель - Палитра тайлов (TilePalette)
- Выпадающий список для выбора тайлсета
- Сетка тайлов с прокруткой
- Белая рамка на выбранном тайле

#### Правая панель - Статусы
Кнопки с toggle_mode = true:
- **B** - Blocking (красный) - непроходимо
- **S** - Shallow Water (голубой) - мелководье
- **D** - Deep Water (синий) - глубокая вода
- **I** - Ice (светло-голубой) - скользкий лёд
- **M** - Mud (коричневый) - замедляющее болото
- **✖** - Clear - очистка статуса

### Взаимоисключающая логика
Система гарантирует, что можно редактировать либо тайлы, либо статусы, но не одновременно:

1. **При выборе тайла:**
   - Снимается выделение со всех кнопок статусов через `set_pressed_no_signal(false)`
   - Убирается фокус с кнопок через `release_focus()`
   - Очищается визуальное выделение в палитре статусов
   - Устанавливается режим `_current_edit_mode = "tiles"`

2. **При выборе статуса:**
   - Снимается выделение с палитры тайлов через `clear_selection()`
   - Очищается выбор тайла через `set_selected_tile(-1)`
   - Устанавливается режим `_current_edit_mode = "status"`
   - Кнопка статуса нажимается через `set_pressed_no_signal(true)`

### Z-индексы слоёв
- Тайлы (WorldMap): -1
- Поверхности (WorldSurface): 1
- Блокировки (WorldBlocking): 2
- Объекты (WorldObjects): зависит от Y позиции

### Сохранение
Кнопка "Сохранить" вызывает сохранение всех трёх слоёв:
- `world_map.save_map_changes()` - тайлы
- `world_blocking.save_blocking_changes()` - блокировки
- `world_surface.save_surface_changes()` - поверхности

## Протокол клиент-сервер

### Формат сообщений
Все сообщения идут в конверте SEC1:
```
SEC1|base64(version|nonce|ciphertext|mac)
```

### Основные команды

#### Аутентификация
- `LOGIN|name|password` → `OK|id|x|y|appearance` или `ERROR`
- `REGISTER|name|password|appearance` → `OK|id|x|y` или `ERROR`

#### Позиция
- `id|name|x|y|appearance` - каждые 50мс
- Сервер рассылает позиции других игроков

#### Чанки карты
- `CHUNK|cx|cy|version` → JSON массив тайлов если version устарела
- `EDIT|{...}` - изменения карты

#### Объекты
- `OBJECTS|cx|cy|version` → JSON массив объектов
- `OBJECT_EDIT|{...}` - изменения объектов

#### Ресурсы
- `RESOURCES|cx|cy|version` → JSON массив ресурсов
- `RESOURCE_EDIT|{...}` - изменения ресурсов

#### Блокировки
- `BLOCKING|cx|cy|version` → JSON массив блокировок
- `BLOCKING_EDIT|{...}` - изменения блокировок

#### Поверхности
- `SURFACE|cx|cy|version` → JSON массив поверхностей
- `SURFACE_EDIT|{...}` - изменения поверхностей

## Структура данных

### Appearance (JSON)
```json
{
  "body": "body_male_light",
  "head": "heads:0:0",
  "hair": "hair_male_short_brown",
  "shirt": "shirt_blue",
  "pants": "pants_brown",
  "shoes": "shoes_leather"
}
```

### Tile Data
```json
{
  "X": 150,
  "Y": 134,
  "TileId": 100052
}
```

### Blocking Data
```json
{
  "EntityId": "uuid",
  "TypeId": "block_1x1",
  "X": 150,
  "Y": 134,
  "CreatedUtc": "2026-01-14T07:56:37Z",
  "UpdatedUtc": "2026-01-14T07:56:37Z"
}
```

### Surface Data
```json
{
  "EntityId": "uuid",
  "TypeId": "water_shallow",
  "X": 150,
  "Y": 134,
  "CreatedUtc": "2026-01-14T07:56:37Z",
  "UpdatedUtc": "2026-01-14T07:56:37Z"
}
```

## Важные константы

### Main.gd
- `VIEW_DISTANCE_CHUNKS = 2` - радиус загрузки чанков
- `SERVER_CONFIRM_TIMEOUT_SEC = 5.0` - таймаут подтверждения от сервера
- `MIN_LOADING_TIME_SEC = 1.2` - минимальное время загрузочного экрана

### Player.gd
- Скорость: `200.0` пикселей/сек (базовая)
- Модификаторы поверхностей применяются умножением

### WorldMap.gd
- `CHUNK_SIZE = 100` - размер чанка в тайлах (100x100)
- `TILE_SIZE = 32` - размер тайла в пикселях

## Файловая структура

```
universesurvival/
  ├── Main.gd, main.tscn              # главная сцена
  ├── MainMenu.gd, main_menu.tscn     # меню
  ├── Player.gd                        # локальный игрок
  ├── RemotePlayer.gd                  # удаленные игроки
  ├── WorldMap.gd                      # карта
  ├── WorldObjects.gd                  # объекты
  ├── WorldResources.gd                # ресурсы
  ├── WorldBlocking.gd                 # блокировки
  ├── WorldSurface.gd                  # поверхности
  ├── TilesetManager.gd                # менеджер тайлсетов
  ├── TilePalette.gd                   # палитра тайлов
  ├── ResourcePalette.gd               # палитра ресурсов
  ├── CharacterAppearance.gd           # paperdoll
  ├── NetworkCrypto.gd                 # шифрование
  ├── data/
  │   ├── object_types.json
  │   ├── resource_types.json
  │   ├── blocking_types.json
  │   └── surface_types.json
  ├── tiles/                           # автоматическое сканирование PNG
  │   ├── terrain.png
  │   ├── Ground.png
  │   └── ...
  ├── resources/
  │   ├── tree_oak.png
  │   └── ...
  └── characters/
      ├── body_*.png
      └── ...
```

## Советы по разработке

### Добавление нового тайлсета
1. Создайте PNG с сеткой 32x32
2. Положите в `universesurvival/tiles/`
3. Тайлсет автоматически появится в редакторе

### Добавление нового типа статуса
1. Добавьте тип в `blocking_types.json` или `surface_types.json`
2. Добавьте кнопку в `main.tscn` (StatusPanel)
3. Добавьте обработчик в `Main.gd`
4. Обновите логику в соответствующем World*.gd

### Отладка
- Консоль Godot показывает логи всех систем
- Используйте print() для отладочного вывода
- Проверяйте логи сервера для UDP-трафика

## Известные особенности

### Toggle кнопки и сигналы
- Используйте `set_pressed_no_signal()` для программного изменения состояния без вызова обработчиков
- Используйте `release_focus()` для снятия визуального фокуса (белой рамки)
- Сигнал `pressed` срабатывает при каждом клике, независимо от состояния
- Сигнал `toggled(bool)` срабатывает только при изменении состояния

### Порядок обработки
1. Клик на кнопку → автоматическое переключение `button_pressed`
2. Генерация сигнала `pressed`
3. Выполнение обработчика
4. `set_pressed_no_signal()` не генерирует сигналы

### Версионирование чанков
- Клиент хранит версию каждого чанка
- Запрос с устаревшей версией возвращает полные данные
- Запрос с актуальной версией возвращает "OK" без данных
